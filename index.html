<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lab Doc Manager</title>
    <meta name="description" content="PWA Pengurusan Dokumen Makmal - Klinik Kesihatan Bintulu">
    <meta name="theme-color" content="#0a1628">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a1628;
            --bg-secondary: #111d33;
            --bg-card: #162240;
            --bg-card-hover: #1a2a4e;
            --accent: #38bdf8;
            --accent-glow: rgba(56, 189, 248, 0.15);
            --accent-dim: rgba(56, 189, 248, 0.6);
            --success: #34d399;
            --success-glow: rgba(52, 211, 153, 0.15);
            --warning: #fbbf24;
            --error: #f87171;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-dim: #64748b;
            --border: rgba(56, 189, 248, 0.12);
            --border-strong: rgba(56, 189, 248, 0.25);
            --radius: 12px;
            --radius-sm: 8px;
            --font: 'DM Sans', -apple-system, sans-serif;
            --mono: 'JetBrains Mono', monospace;
        }

        body {
            font-family: var(--font);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* Ambient background */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at 30% 20%, rgba(56, 189, 248, 0.04) 0%, transparent 50%),
                        radial-gradient(ellipse at 70% 80%, rgba(52, 211, 153, 0.03) 0%, transparent 50%);
            z-index: 0;
            pointer-events: none;
        }

        .app {
            position: relative;
            z-index: 1;
            max-width: 520px;
            margin: 0 auto;
            padding: 20px 16px 100px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 24px 0 32px;
        }

        .header-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent), #818cf8);
            border-radius: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            font-size: 22px;
            box-shadow: 0 8px 24px rgba(56, 189, 248, 0.2);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 13px;
            color: var(--text-dim);
            font-weight: 500;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border-strong);
            border-radius: var(--radius);
            padding: 40px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--accent-glow);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .upload-zone:hover::before, .upload-zone.dragover::before {
            opacity: 1;
        }

        .upload-icon {
            font-size: 36px;
            margin-bottom: 12px;
            display: block;
        }

        .upload-zone h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .upload-zone p {
            font-size: 12px;
            color: var(--text-dim);
        }

        .upload-input {
            display: none;
        }

        /* Processing Card */
        .process-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 16px;
            display: none;
            animation: slideUp 0.4s ease;
        }

        .process-card.active { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .process-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .process-file-icon {
            width: 40px;
            height: 40px;
            background: rgba(239, 68, 68, 0.12);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .process-file-info h4 {
            font-size: 13px;
            font-weight: 600;
            word-break: break-all;
        }

        .process-file-info p {
            font-size: 11px;
            color: var(--text-dim);
            font-family: var(--mono);
        }

        /* Steps */
        .steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            flex-shrink: 0;
            background: var(--bg-card);
            color: var(--text-dim);
            border: 1.5px solid var(--border);
            transition: all 0.3s;
        }

        .step.active .step-icon {
            background: var(--accent-glow);
            border-color: var(--accent);
            color: var(--accent);
            animation: pulse 1.5s infinite;
        }

        .step.done .step-icon {
            background: var(--success-glow);
            border-color: var(--success);
            color: var(--success);
        }

        .step.error .step-icon {
            background: rgba(248, 113, 113, 0.15);
            border-color: var(--error);
            color: var(--error);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.3); }
            50% { box-shadow: 0 0 0 6px rgba(56, 189, 248, 0); }
        }

        /* Extracted Data Preview */
        .extracted-data {
            margin-top: 16px;
            display: none;
            animation: slideUp 0.4s ease;
        }

        .extracted-data.active { display: block; }

        .data-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .data-grid {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .data-row {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            align-items: baseline;
        }

        .data-label {
            font-size: 11px;
            color: var(--text-dim);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 110px;
            flex-shrink: 0;
        }

        .data-value {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            word-break: break-word;
        }

        .data-value.empty {
            color: var(--text-dim);
            font-style: italic;
        }

        /* Success Banner */
        .success-banner {
            margin-top: 16px;
            padding: 16px;
            background: var(--success-glow);
            border: 1px solid rgba(52, 211, 153, 0.25);
            border-radius: var(--radius);
            display: none;
            animation: slideUp 0.4s ease;
        }

        .success-banner.active { display: block; }

        .success-banner h4 {
            font-size: 14px;
            color: var(--success);
            margin-bottom: 4px;
        }

        .success-banner p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .success-banner a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        /* Error Banner */
        .error-banner {
            margin-top: 16px;
            padding: 16px;
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.25);
            border-radius: var(--radius);
            display: none;
            animation: slideUp 0.4s ease;
        }

        .error-banner.active { display: block; }

        .error-banner h4 {
            font-size: 14px;
            color: var(--error);
            margin-bottom: 4px;
        }

        .error-banner p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* History */
        .history {
            margin-top: 32px;
        }

        .history-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-count {
            font-size: 11px;
            background: var(--bg-card);
            padding: 2px 8px;
            border-radius: 99px;
            font-family: var(--mono);
            color: var(--text-dim);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: var(--bg-card-hover);
        }

        .history-item-icon {
            width: 32px;
            height: 32px;
            background: var(--success-glow);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .history-item-info {
            flex: 1;
            min-width: 0;
        }

        .history-item-info h4 {
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-info p {
            font-size: 11px;
            color: var(--text-dim);
            font-family: var(--mono);
        }

        .history-item-link {
            color: var(--accent);
            font-size: 16px;
            text-decoration: none;
            padding: 4px;
        }

        /* Settings Panel */
        .settings-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: var(--bg-card);
            border: 1px solid var(--border-strong);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }

        .settings-toggle:hover {
            transform: scale(1.08);
            border-color: var(--accent);
        }

        .settings-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-strong);
            border-radius: 20px 20px 0 0;
            padding: 24px 20px 40px;
            z-index: 20;
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 520px;
            margin: 0 auto;
        }

        .settings-panel.open { transform: translateY(0); }

        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 15;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .settings-overlay.open { opacity: 1; pointer-events: auto; }

        .settings-panel h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .setting-group {
            margin-bottom: 14px;
        }

        .setting-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .setting-group input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--mono);
            font-size: 12px;
            outline: none;
            transition: border-color 0.2s;
        }

        .setting-group input:focus {
            border-color: var(--accent);
        }

        .setting-group input::placeholder {
            color: var(--text-dim);
        }

        .save-settings-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent), #818cf8);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-family: var(--font);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: opacity 0.2s;
        }

        .save-settings-btn:hover { opacity: 0.9; }

        /* Status indicator */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.connected { background: var(--success); box-shadow: 0 0 6px var(--success); }
        .status-dot.disconnected { background: var(--error); }

        /* Responsive */
        @media (max-width: 380px) {
            .data-row { flex-direction: column; gap: 2px; }
            .data-label { min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="header">
            <div class="header-icon">üî¨</div>
            <h1>Lab Doc Manager</h1>
            <p>Klinik Kesihatan Bintulu &nbsp;¬∑&nbsp; <span class="status-dot" id="statusDot"></span> <span id="statusText" style="font-size:11px"></span></p>
        </div>

        <!-- Upload Zone -->
        <div class="upload-zone" id="uploadZone">
            <span class="upload-icon">üìÑ</span>
            <h3>Muat Naik PDF</h3>
            <p>Tap atau drag & drop dokumen makmal</p>
            <input type="file" accept="application/pdf" class="upload-input" id="fileInput">
        </div>

        <!-- Processing Card -->
        <div class="process-card" id="processCard">
            <div class="process-header">
                <div class="process-file-icon">üìë</div>
                <div class="process-file-info">
                    <h4 id="fileName">-</h4>
                    <p id="fileSize">-</p>
                </div>
            </div>
            <div class="steps">
                <div class="step" id="step1">
                    <div class="step-icon">1</div>
                    <span>Muat naik ke Google Drive</span>
                </div>
                <div class="step" id="step2">
                    <div class="step-icon">2</div>
                    <span>AI sedang baca dokumen...</span>
                </div>
                <div class="step" id="step3">
                    <div class="step-icon">3</div>
                    <span>Simpan metadata ke Sheet</span>
                </div>
            </div>
        </div>

        <!-- Extracted Data Preview -->
        <div class="extracted-data" id="extractedData">
            <div class="data-title">‚ú¶ Data Diekstrak</div>
            <div class="data-grid" id="dataGrid"></div>
        </div>

        <!-- Success Banner -->
        <div class="success-banner" id="successBanner">
            <h4>‚úì Berjaya!</h4>
            <p>Dokumen telah disimpan dan metadata direkod dalam <a href="#" id="sheetLink" target="_blank">Google Sheet</a>.</p>
        </div>

        <!-- Error Banner -->
        <div class="error-banner" id="errorBanner">
            <h4>‚úï Ralat</h4>
            <p id="errorMsg">Sesuatu tidak kena. Sila cuba lagi.</p>
        </div>

        <!-- History -->
        <div class="history" id="historySection" style="display:none">
            <div class="history-title">
                Sejarah Muat Naik <span class="history-count" id="historyCount">0</span>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>

    <!-- Settings Toggle -->
    <div class="settings-toggle" id="settingsToggle">‚öôÔ∏è</div>
    <div class="settings-overlay" id="settingsOverlay"></div>
    <div class="settings-panel" id="settingsPanel">
        <h3>‚öôÔ∏è Tetapan</h3>
        <div class="setting-group">
            <label>Google Apps Script Web App URL</label>
            <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/xxxxx/exec">
        </div>
        <div class="setting-group">
            <label>Gemini API Key</label>
            <input type="password" id="geminiKey" placeholder="AIzaSy...">
        </div>
        <div class="setting-group">
            <label>Google Drive Folder ID</label>
            <input type="text" id="folderId" placeholder="ID folder Google Drive">
        </div>
        <button class="save-settings-btn" id="saveSettings">Simpan Tetapan</button>
    </div>

    <script>
        // ========== State ==========
        const state = {
            gasUrl: localStorage.getItem('gasUrl') || '',
            geminiKey: localStorage.getItem('geminiKey') || '',
            folderId: localStorage.getItem('folderId') || '',
            history: JSON.parse(localStorage.getItem('uploadHistory') || '[]')
        };

        // ========== DOM ==========
        const $ = id => document.getElementById(id);
        const uploadZone = $('uploadZone');
        const fileInput = $('fileInput');
        const processCard = $('processCard');
        const extractedData = $('extractedData');
        const successBanner = $('successBanner');
        const errorBanner = $('errorBanner');
        const settingsToggle = $('settingsToggle');
        const settingsPanel = $('settingsPanel');
        const settingsOverlay = $('settingsOverlay');

        // ========== Init ==========
        function init() {
            // Load settings into inputs
            $('gasUrl').value = state.gasUrl;
            $('geminiKey').value = state.geminiKey;
            $('folderId').value = state.folderId;

            updateStatus();
            renderHistory();

            // If no settings, auto-open settings
            if (!state.gasUrl) {
                setTimeout(() => toggleSettings(true), 800);
            }
        }

        function updateStatus() {
            const connected = state.gasUrl && state.geminiKey;
            $('statusDot').className = `status-dot ${connected ? 'connected' : 'disconnected'}`;
            $('statusText').textContent = connected ? 'Sedia' : 'Perlu tetapan';
        }

        // ========== Settings ==========
        function toggleSettings(open) {
            settingsPanel.classList.toggle('open', open);
            settingsOverlay.classList.toggle('open', open);
        }

        settingsToggle.addEventListener('click', () => toggleSettings(true));
        settingsOverlay.addEventListener('click', () => toggleSettings(false));

        $('saveSettings').addEventListener('click', () => {
            state.gasUrl = $('gasUrl').value.trim();
            state.geminiKey = $('geminiKey').value.trim();
            state.folderId = $('folderId').value.trim();

            localStorage.setItem('gasUrl', state.gasUrl);
            localStorage.setItem('geminiKey', state.geminiKey);
            localStorage.setItem('folderId', state.folderId);

            updateStatus();
            toggleSettings(false);
        });

        // ========== Upload ==========
        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', e => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') handleFile(file);
        });

        fileInput.addEventListener('change', e => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
            fileInput.value = '';
        });

        // ========== Main Process ==========
        async function handleFile(file) {
            if (!state.gasUrl || !state.geminiKey) {
                toggleSettings(true);
                return;
            }

            // Reset UI
            resetUI();
            processCard.classList.add('active');
            $('fileName').textContent = file.name;
            $('fileSize').textContent = formatSize(file.size);

            try {
                // Convert to base64
                const base64 = await fileToBase64(file);

                // Step 1: Upload to Drive
                setStep(1, 'active');
                const uploadResult = await uploadToDrive(base64, file.name);
                setStep(1, 'done');

                // Step 2: AI Extract
                setStep(2, 'active');
                const extracted = await extractWithGemini(base64);
                setStep(2, 'done');

                // Show extracted data
                showExtractedData(extracted);

                // Step 3: Write to Sheet
                setStep(3, 'active');
                await writeToSheet(extracted, file.name, uploadResult.fileUrl);
                setStep(3, 'done');

                // Success
                successBanner.classList.add('active');
                if (uploadResult.sheetUrl) {
                    $('sheetLink').href = uploadResult.sheetUrl;
                }

                // Add to history
                addToHistory(file.name, uploadResult.fileUrl, extracted);

            } catch (err) {
                console.error(err);
                errorBanner.classList.add('active');
                $('errorMsg').textContent = err.message || 'Sesuatu tidak kena. Sila cuba lagi.';

                // Mark current active step as error
                ['step1', 'step2', 'step3'].forEach(id => {
                    if ($(id).classList.contains('active')) {
                        setStep(parseInt(id.slice(-1)), 'error');
                    }
                });
            }
        }

        // ========== API Calls ==========
        async function uploadToDrive(base64, fileName) {
            const response = await fetch(state.gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'upload',
                    fileName: fileName,
                    base64: base64.split(',')[1], // Remove data:application/pdf;base64,
                    folderId: state.folderId
                })
            });

            const result = await response.json();
            if (result.error) throw new Error(result.error);
            return result;
        }

        async function extractWithGemini(base64) {
            const b64Data = base64.split(',')[1];
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            {
                                inlineData: {
                                    mimeType: 'application/pdf',
                                    data: b64Data
                                }
                            },
                            {
                                text: `Analisis dokumen makmal/laporan perubatan ini dan ekstrak maklumat berikut dalam format JSON sahaja (tanpa markdown, tanpa backtick). Jika maklumat tidak ditemui, gunakan string kosong "".

{
  "name": "Nama pesakit/subjek",
  "requesting_dr": "Nama doktor yang meminta",
  "location": "Lokasi/klinik",
  "ic_no": "Nombor IC",
  "dob": "Tarikh lahir (format: DD.MM.YYYY)",
  "age": "Umur",
  "collected_datetime": "Tarikh dan masa sampel dikutip",
  "received_datetime": "Tarikh dan masa sampel diterima",
  "test": "Nama ujian makmal yang dijalankan (contoh: Anti-Cyclic Citrullinated Peptide IgG, FBC, Renal Profile)",
  "result": "Keputusan ujian termasuk nilai dan interpretation jika ada (contoh: <4.6 (Negative), 5.2 mmol/L (Normal))"
}

PENTING: 
- Jawab HANYA dengan JSON. Tiada teks lain.
- Jika ada LEBIH DARI SATU ujian, gabungkan dengan " | " sebagai pemisah.
  Contoh test: "Anti-CCP IgG | Rheumatoid Factor"
  Contoh result: "<4.6 (Negative) | 12 IU/mL (Negative)"`
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 1024
                    }
                })
            });

            const data = await response.json();
            
            if (data.error) {
                throw new Error(`Gemini API: ${data.error.message}`);
            }

            let text = data.candidates[0].content.parts[0].text;
            // Clean response - remove markdown fences if present
            text = text.replace(/```json\s*/gi, '').replace(/```\s*/gi, '').trim();
            
            return JSON.parse(text);
        }

        async function writeToSheet(extracted, fileName, fileUrl) {
            const response = await fetch(state.gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'writeSheet',
                    data: {
                        name: extracted.name || '',
                        requesting_dr: extracted.requesting_dr || '',
                        location: extracted.location || 'Bintulu, Klinik Kesihatan',
                        ic_no: extracted.ic_no || '',
                        dob: extracted.dob || '',
                        age: extracted.age || '',
                        collected_datetime: extracted.collected_datetime || '',
                        received_datetime: extracted.received_datetime || '',
                        test: extracted.test || '',
                        result: extracted.result || '',
                        file_name: fileName,
                        file_url: fileUrl
                    }
                })
            });

            const result = await response.json();
            if (result.error) throw new Error(result.error);
            return result;
        }

        // ========== UI Helpers ==========
        function resetUI() {
            processCard.classList.remove('active');
            extractedData.classList.remove('active');
            successBanner.classList.remove('active');
            errorBanner.classList.remove('active');
            ['step1', 'step2', 'step3'].forEach(id => {
                $(id).className = 'step';
            });
        }

        function setStep(num, status) {
            const step = $(`step${num}`);
            step.className = `step ${status}`;
            const icons = { active: '‚óâ', done: '‚úì', error: '‚úï' };
            step.querySelector('.step-icon').textContent = icons[status] || num;
        }

        const fieldLabels = {
            name: 'Nama',
            requesting_dr: 'Requesting Dr.',
            location: 'Lokasi',
            ic_no: 'No. IC',
            dob: 'Tarikh Lahir',
            age: 'Umur',
            collected_datetime: 'Kutip',
            received_datetime: 'Terima',
            test: 'Ujian',
            result: 'Keputusan'
        };

        function showExtractedData(data) {
            const grid = $('dataGrid');
            grid.innerHTML = '';

            Object.entries(fieldLabels).forEach(([key, label]) => {
                const val = data[key] || '';
                grid.innerHTML += `
                    <div class="data-row">
                        <span class="data-label">${label}</span>
                        <span class="data-value ${!val ? 'empty' : ''}">${val || 'Tidak ditemui'}</span>
                    </div>
                `;
            });

            extractedData.classList.add('active');
        }

        function addToHistory(fileName, fileUrl, extracted) {
            const item = {
                fileName,
                fileUrl,
                name: extracted.name || '-',
                date: new Date().toLocaleString('ms-MY')
            };
            state.history.unshift(item);
            if (state.history.length > 50) state.history.pop();
            localStorage.setItem('uploadHistory', JSON.stringify(state.history));
            renderHistory();
        }

        function renderHistory() {
            if (state.history.length === 0) {
                $('historySection').style.display = 'none';
                return;
            }

            $('historySection').style.display = 'block';
            $('historyCount').textContent = state.history.length;

            $('historyList').innerHTML = state.history.slice(0, 20).map(h => `
                <div class="history-item">
                    <div class="history-item-icon">‚úì</div>
                    <div class="history-item-info">
                        <h4>${h.name}</h4>
                        <p>${h.date}</p>
                    </div>
                    ${h.fileUrl ? `<a href="${h.fileUrl}" target="_blank" class="history-item-link">‚Üó</a>` : ''}
                </div>
            `).join('');
        }

        // ========== Utils ==========
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // ========== PWA Service Worker ==========
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }

        // Init
        init();
    </script>
</body>
</html>
